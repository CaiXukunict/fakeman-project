# FakeMan 格式化输出系统

## 概述

为了让FakeMan能够更灵活地与系统交互，我们添加了特殊的输出格式支持。AI现在可以通过特定格式来：
1. 添加新能力到ability系统
2. 执行系统命令
3. 进行普通对话交流

## 支持的格式

### 格式A：添加新能力（Ability）

当AI需要扩展自己的能力时，可以使用此格式创建新的ability：

````markdown
```ability
<ability_name>能力名称</ability_name>
<description>能力的详细描述和用途</description>
<code>
# Python代码实现
def ability_function():
    '''能力函数的实现'''
    # 具体代码
    pass
</code>
```
````

**示例**：

````markdown
```ability
<ability_name>获取天气</ability_name>
<description>获取指定城市的天气信息</description>
<code>
def get_weather(city):
    import requests
    url = f"https://api.weather.com/{city}"
    response = requests.get(url)
    return response.json()
</code>
```
````

### 格式B：执行系统命令（Command）

当AI需要执行命令行指令时，可以使用此格式：

````markdown
```command
<cmd>具体命令内容</cmd>
<reason>执行此命令的原因和目的</reason>
```
````

**示例**：

````markdown
```command
<cmd>dir /s</cmd>
<reason>递归查看所有文件和子目录，了解项目结构</reason>
```
````

````markdown
```command
<cmd>python test.py</cmd>
<reason>运行测试脚本验证新添加的功能</reason>
```
````

### 格式C：普通交流

日常对话直接使用自然语言，无需特殊格式：

```
你好！我理解你的问题了。让我来帮助你解决...
```

## 使用场景

### 场景1：AI需要新能力

**用户**: "你能获取天气信息吗？"

**AI**: 
```
我现在还没有获取天气的能力，但我可以为自己添加这个功能：

```ability
<ability_name>获取天气信息</ability_name>
<description>通过API获取指定城市的实时天气</description>
<code>
def get_weather(city):
    # 实现天气API调用
    return weather_data
</code>
```

现在我就有获取天气的能力了！
```

### 场景2：AI需要执行命令

**用户**: "帮我查看当前目录有什么文件"

**AI**:
```
让我为你查看：

```command
<cmd>dir</cmd>
<reason>查看当前目录的文件列表</reason>
```

执行完成后我会告诉你结果。
```

### 场景3：混合使用

**AI**:
```
为了完成这个任务，我需要：

1. 首先添加一个辅助函数：

```ability
<ability_name>数据处理</ability_name>
<description>处理CSV数据</description>
<code>
import pandas as pd
def process_csv(file):
    return pd.read_csv(file)
</code>
```

2. 然后执行数据分析：

```command
<cmd>python analyze.py data.csv</cmd>
<reason>运行分析脚本处理数据</reason>
```

这样就能完成数据分析任务了。
```

## 技术实现

### 响应解析器

`action_model/response_parser.py` 负责解析AI的输出：

```python
from action_model.response_parser import get_response_parser

parser = get_response_parser()
result = parser.parse_response(ai_response)

# 结果结构
{
    'type': 'text' | 'ability' | 'command' | 'mixed',
    'content': '纯文本内容',
    'abilities': [...],  # 提取的ability列表
    'commands': [...],   # 提取的command列表
    'raw': '原始响应'
}
```

### 提示词配置

格式说明已添加到以下提示词中：

1. **思考提示词** (`action_model/prompts/thinking_prompts.py`)
   - `THINKING_SYSTEM_PROMPT` - 系统级提示

2. **行动提示词** (`action_model/prompts/action_prompts.py`)
   - `ACTION_SYSTEM_PROMPT` - 行动系统提示

3. **主程序提示词** (`main.py`, `main_refactored.py`)
   - `_think_and_decide` 方法中的提示词

## 测试

运行测试脚本验证解析器：

```bash
python test_parser.py
```

预期输出：
```
============================================================
测试1: ability格式
============================================================
类型: ability
能力数: 1
能力名: 获取天气
...

============================================================
测试2: command格式
============================================================
类型: command
命令数: 1
命令: dir
...

✅ 所有测试通过！
```

## 未来集成

### Ability系统集成

解析到的ability可以自动注册到ability系统：

```python
if result['abilities']:
    from ability.ability_manager import get_ability_manager
    manager = get_ability_manager()
    
    for ability in result['abilities']:
        manager.register_ability(
            name=ability['name'],
            description=ability['description'],
            code=ability['code']
        )
```

### Command执行器集成

解析到的command可以通过执行器运行：

```python
if result['commands']:
    from action_model.command_executor import execute_command
    
    for cmd_info in result['commands']:
        execute_command(
            cmd=cmd_info['cmd'],
            reason=cmd_info['reason']
        )
```

## 注意事项

1. **安全性**：
   - Command执行需要添加安全检查
   - Ability代码需要沙箱环境
   - 避免执行危险命令

2. **权限控制**：
   - 某些命令可能需要用户确认
   - 某些ability可能需要权限审核

3. **错误处理**：
   - 解析失败时回退到普通文本模式
   - 执行失败时提供明确的错误信息

## 示例对话

**完整对话示例**：

```
用户: 你能帮我分析一下data.csv文件吗？

AI: 当然可以！让我先添加数据分析能力：

```ability
<ability_name>CSV数据分析</ability_name>
<description>读取和分析CSV文件</description>
<code>
import pandas as pd
import matplotlib.pyplot as plt

def analyze_csv(filepath):
    df = pd.read_csv(filepath)
    return df.describe()
</code>
```

现在让我查看文件：

```command
<cmd>python -c "import pandas as pd; print(pd.read_csv('data.csv').head())"</cmd>
<reason>查看CSV文件的前几行数据以了解结构</reason>
```

执行完成后我会给你详细的分析结果。

用户: [看到结果] 很好，继续

AI: 根据数据，我发现了几个有趣的模式...
[继续普通对话]
```

## 总结

通过这套格式化输出系统，FakeMan可以：
- ✅ 动态扩展自己的能力
- ✅ 执行系统命令完成任务
- ✅ 保持自然的对话交流
- ✅ 根据需求灵活组合不同格式

这大大增强了AI的实用性和自主性！

